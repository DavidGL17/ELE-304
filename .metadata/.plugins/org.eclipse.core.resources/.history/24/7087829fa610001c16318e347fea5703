/*
 * message_sending.c
 *
 *  Created on: 4 sept. 2021
 *      Author: xxpow
 */

#include "message_sending.h"
#include "stdbool.h"
#include "stm32h7xx_it.h"
#include "print_server.h"

//Override definition of both functions that are called when SEV interrupt is received
void SEV_handler(void) {
#ifdef CORE_CM7 //in core CM7
	//nothing yet
#else //In core CM4
	switch (*message_info_ptr) {	//specific behaviour depending on the message received
	case CORE_MESSAGE_CM7_CM4_NEW_PRINT:
		PRINTF("%s", (char* )message_content_ptr);	//TODO add in the printf the content of the buffer given by cm7
		break;
	default:
		break;
	}
#endif
	message_sending_ready = 1;
}
bool messageSendingInit() {
	//TODO init le reste des attributs n√©cessaires pour l'envoi de messages
	return true;
}

bool checkMessageValue(uint32_t message);	//checks if the message is a defined message

void sendMessage(uint32_t message,argc void *args) {
	if (!checkMessageValue(message)) {
		return;
	}
	while (!message_sending_ready) {
		//wait for message_sending to be ready
		//Possibility to improve with mutex/semaphore, dont know if there are any given by the os
	}
	message_sending_ready = 0;
	switch (message) {
		case CORE_MESSAGE_CM7_CM4_NEW_PRINT:
		for (int i = 0;i<PS_PRINT_BUFFER_SIZE;++i) {
			pool_buf_cm7[i] = args
		}
		message_content_ptr = (void*) pool_buf_cm7;
		break;
	}
	*message_info_ptr = message;
}

bool checkMessageValue(uint32_t message) {
	if (message > CORE_MESSAGE_MAX_VALUE) {
		return false;
	}
	return true;
}
